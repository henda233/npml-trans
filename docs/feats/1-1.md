好的，这是针对功能 1.1 读取文件 的详细开发文档，考虑到与项目其他功能的交互。

功能 1.1: 读取文件 (Read File)

1. 目标

实现一个核心功能，能够根据给定的文件路径（相对或绝对）读取文件内容，并可选地支持读取文件的特定行号范围（如 #L 或 #L1:L2）。该功能将返回带有行号前缀的文件内容字符串，作为项目中处理文件内容的基础。

2. 输入 (Input)

*   filePathWithRange: string: 一个包含文件路径和可选行号范围的字符串。
    *   格式: path/to/file.ext[#line_start[:line_end]]
    *   示例:
        *   ./src/main.npml (读取整个文件)
        *   ./docs/guide.md#10 (读取 guide.md 的第10行)
        *   ../routes/login.tsx#12:36 (读取 login.tsx 的第12行到第36行)
        *   /absolute/path/to/config.json (读取绝对路径文件)
    *   解析:
        *   filePath: string: 从 filePathWithRange 中解析出的纯文件路径部分。
        *   startLine: number | null: 从 filePathWithRange 中解析出的起始行号（1-based），如果未指定则为 null。
        *   endLine: number | null: 从 filePathWithRange 中解析出的结束行号（1-based），如果未指定则为 null。

3. 输出 (Output)

*   Promise: 一个 Promise，解析后返回一个字符串。
    *   成功时 (Success): 返回包含行号前缀的文件内容字符串。每一行的格式为 [行号] 内容。
        *   如果指定了行号范围，则只返回该范围内的行。
        *   如果未指定行号范围，则返回整个文件内容。
        *   行号从1开始计数。
        *   如果文件为空，返回 ""。
        *   如果指定的行号范围超出文件实际行数，返回该范围内实际存在的行（例如，文件只有50行，请求#45:100，则返回45-50行）。
    *   失败时 (Failure):
        *   如果文件不存在或无法读取，返回 null。
        *   如果 filePathWithRange 格式无效（例如，行号部分不是数字），返回 null。

4. 实现细节 (Implementation Details)

*   环境: 使用 Deno 运行时和 TypeScript 开发。
*   依赖:
    *   Deno.readTextFile: 用于异步读取文件内容。
    *   path 模块 (例如 std/path): 用于处理和解析文件路径，确保路径的正确性。
    *   std/flags (可选): 用于解析命令行参数，但在此功能内部实现路径范围解析即可。
*   步骤:
    1.  解析路径和范围:
        *   使用正则表达式或其他字符串处理方法，从 filePathWithRange 中分离出 filePath 和 range 部分。
        *   正则表达式示例: ^(.+?)(?:#(d+)(?::(d+))?)?$
            *   (.+?): 捕获文件路径部分（非贪婪）。
            *   (?:#(d+)(?::(d+))?)?: 可选的行号部分。
                *   #: 必须的范围起始符。
                *   (d+): 捕获起始行号。
                *   (?::(d+))?: 可选的 : 后跟结束行号。
        *   验证捕获到的行号是否为有效的正整数，如果不是，返回 null。
    2.  读取文件:
        *   调用 Deno.readTextFile(filePath) 读取文件的原始字符串内容。
        *   如果读取失败（例如文件不存在），捕获错误并返回 null。
    3.  处理行号范围:
        *   将读取到的文件内容按行分割成字符串数组（例如使用 split('n') 或 split(/r?n/) 以兼容不同换行符）。
        *   如果指定了 startLine:
            *   调整为数组索引（0-based）。
            *   如果 startLine 超出数组长度，返回 ""。
            *   如果未指定 endLine，则只取从 startLine 开始到文件末尾的部分。
            *   如果指定了 endLine:
                *   调整为数组索引。
                *   计算实际的切片范围，确保不超出数组边界。
                *   只取从 startLine 到 endLine 的部分（包含 endLine 行）。
        *   如果未指定 startLine，则使用整个数组。
    4.  添加行号:
        *   遍历最终确定的行数组。
        *   对于每一行，生成 [行号] 行内容 的格式字符串。行号基于原始文件的行号（1-based）。
    5.  返回结果:
        *   将所有带行号的行用 n 连接成一个字符串并返回。

5. 与其他功能的交互 (Interactions)

*   功能 1.2 (文件内容管理):
    *   1.1 的输出（带行号的字符串）将作为输入提供给功能 1.2 的管理类，以便存储和后续检索。
*   功能 1.4 (解析NPML引用):
    *   1.4 负责解析NPML代码中的 !() 语法，提取出 filePathWithRange 字符串。
    *   1.4 将解析出的 filePathWithRange 传递给 1.1 来实际读取内容。
*   功能 1.6 (生成NPML翻译请求文):
    *   1.6 会间接使用 1.1 的功能。它需要获取原始NPML文件和所有被引用文件的内容，这些内容的获取都依赖于 1.1 提供的能力。
*   功能 1.3 (行号标注):
    *   1.1 的实现中直接包含了行号标注的逻辑。它读取文件内容后，会按要求为每一行添加 [行号] 前缀。因此，1.3 的逻辑内嵌在 1.1 中。

6. 错误处理 (Error Handling)

*   文件不存在或无访问权限: 捕获 Deno.errors.NotFound 或其他相关错误，返回 null。
*   路径格式错误: 解析 filePathWithRange 时，若格式不符合预期（如行号非数字），返回 null。
*   行号范围无效: 如 startLine > endLine，或行号为负数，返回 null。

7. 单元测试 (Unit Tests) - 示例

*   测试读取完整文件。
*   测试读取单行（#10）。
*   测试读取多行范围（#12:20）。
*   测试读取超出文件长度的范围。
*   测试读取不存在的文件。
*   测试解析无效格式的 filePathWithRange。
*   测试带有行号前缀的输出格式是否正确。