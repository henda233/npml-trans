
### 功能 1.6 开发文档：NPML翻译请求文生成（文件内容聚合）

#### 功能概述
本功能是 NPML 翻译器项目的核心功能，负责将多个来源的信息聚合、格式化，并最终生成一个符合特定模板的 Markdown 文档（NPML 翻译请求文）。此文档旨在为 AI 翻译或代码理解提供全面、结构化的上下文信息。它整合了原始 NPML 代码、其引用的外部内容以及可选的项目目录结构。

#### 接口与实现类

*   **核心类**: `NpmlRequestGenerator`
    *   负责协调 NPML 文件读取、引用内容提取、目录结构生成以及最终文档的聚合和格式化。
*   **方法**: `async generateRequest(npmlFilePath: string, options: GenerationOptions): Promise<string | null>`
    *   **功能**: 接收一个 NPML 文件路径和一个包含可选配置的 `options` 对象，执行完整的聚合流程，并返回最终的 Markdown 文档内容。
    *   **参数**:
        *   `npmlFilePath: string`: 指向待处理的 `.npml` 文件的路径。
        *   `options: GenerationOptions`:
            *   `includeDirTree?: string`: 一个可选的目录路径。如果提供，将生成该目录的结构树并包含在最终文档中。
            *   `skipReferences?: boolean`: 一个布尔值。如果为 `true`，则跳过读取和聚合引用内容。
            *   `outputToClipboard?: boolean`: 一个布尔值。如果为 `true`，则在生成文档后将其内容复制到剪贴板。
    *   **返回值**: 一个 `Promise`，其结果为 `string | null`。
        *   **成功 (`string`)**: 返回一个完整的、格式化的 Markdown 字符串，即 NPML 翻译请求文。
        *   **失败 (`null`)**: 如果在读取主 NPML 文件、读取引用内容、生成目录树或写入剪贴板（如果启用）的过程中发生任何错误，则返回 `null`。

#### 输入与输出

*   **输入**:
    *   `npmlFilePath: string`: 主 NPML 代码文件的路径。
    *   `options: GenerationOptions`: 一个配置对象，用于控制生成行为（如是否包含目录树、是否跳过引用、是否输出到剪贴板）。
*   **输出**:
    *   **成功 (`string`)**: 符合 `project.md` 中定义格式的 Markdown 文档。格式如下：
        ```markdown
        # NPML 翻译请求文

        ## NPML代码:
        [带行号的主 NPML 文件内容]

        ## 项目结构说明:
        [由 `DirectoryTreeGenerator` 生成的目录树，如果 `includeDirTree` 选项被设置]
        [如果 `includeDirTree` 未设置，则此部分为空或省略]

        ## 引用内容:
        [如果 `skipReferences` 为 `false` 且存在引用内容]
        // [引用文件路径 1]
        [带行号的引用文件 1 内容]
        ---

        // [引用文件路径 2]
        [带行号的引用文件 2 内容]
        ---

        [更多引用内容...]
        [如果 `skipReferences` 为 `true` 或无引用内容，则此部分为空或省略]
        ```
    *   **失败 (`null`)**: 如果任何依赖步骤（如读取文件）失败，则返回 `null`。

#### 实现细节

1.  **主 NPML 文件读取与行号化**:
    *   调用 `FileReader` (或类似功能模块) 的 `readLines` 方法读取 `npmlFilePath` 的全部内容。
    *   调用 `LineNumberer` (或类似功能模块) 的 `addLineNumbers` 方法，为读取到的每一行添加行号。

2.  **目录结构生成 (可选)**:
    *   检查 `options.includeDirTree` 是否存在。
    *   如果存在，实例化 `DirectoryTreeGenerator` 并调用其 `generateTree` 方法。如果返回 `null`，则记录错误或返回 `null`。

3.  **引用内容提取与行号化 (可选)**:
    *   检查 `options.skipReferences` 是否为 `true`。
    *   如果为 `false`，使用 `ReferenceParser` (或类似功能模块) 从第 1 步中已读取的主 NPML 内容中提取所有 `!(...)` 格式的引用标记。
    *   遍历所有提取到的引用路径和行号范围。
    *   对每个引用路径，调用 `FileReader` 读取指定范围的内容，并使用 `LineNumberer` 添加行号。
    *   将每个引用文件的路径（格式为 `// path/to/file`）和其带行号的内容存储起来，内容之间用 `---` 分隔。

4.  **内容聚合**:
    *   按照 `project.md` 中定义的格式，将第 1、2、3 步骤的结果拼接成一个完整的 Markdown 字符串。

5.  **输出处理**:
    *   如果 `options.outputToClipboard` 为 `true`，使用 Deno 的剪贴板 API (如 `deno run --allow-write=clipboard ...` 并配合相关库或原生能力，或根据 Deno 最终实现) 将聚合后的字符串写入剪贴板。
    *   如果未指定剪贴板输出，则将字符串返回给调用者，由上层逻辑（如 CLI 模块）决定是否写入文件。

#### 功能测试

*   **标准流程**: 使用一个包含多个引用、且 `-t` 指定的目录存在的情况，验证最终输出的 Markdown 文档格式是否正确，内容是否完整，行号是否准确。
*   **无引用 NPML**: 测试一个不含任何 `!(...)` 引用的简单 NPML 文件，验证 "引用内容" 部分为空或省略。
*   **无目录结构**: 不使用 `-t` 参数，验证 "项目结构说明" 部分为空或省略。
*   **跳过引用**: 使用 `-dr` 参数，验证即使 NPML 文件中有引用标记，"引用内容" 部分也为空或省略。
*   **无效 NPML 文件路径**: 提供一个不存在的 `.npml` 文件路径，验证函数返回 `null`。
*   **无效引用路径**: 在 NPML 文件中放置一个指向不存在文件的引用 `!(nonexistent/file.txt)`，验证函数返回 `null` 或能优雅处理（例如跳过该引用并记录日志）。
*   **无效目录树路径**: 使用 `-t` 指向一个不存在或不是目录的路径，验证函数返回 `null`。
*   **输出到剪贴板**: 使用 `-c` 参数，验证函数成功返回内容，并且该内容已正确复制到系统剪贴板。
*   **输出到文件**: 不使用 `-c` 参数，验证函数成功返回内容，并且该内容已写入到与 `.npml` 文件同名的 `.md` 文件中。

#### 与其他功能的关系

*   **功能 1.1 (文件按行读取)**: `NpmlRequestGenerator` 依赖此功能来读取主 NPML 文件及其所有引用的外部文件内容。
*   **功能 1.3 (文件内容行号显示)**: `NpmlRequestGenerator` 依赖此功能为所有聚合的文件内容（主 NPML 文件和所有引用文件）添加行号。
*   **功能 1.4 (NPML引用内容读取)**: `NpmlRequestGenerator` 依赖此功能来解析主 NPML 文件内容，提取出所有需要读取的引用路径和行号范围。
*   **功能 1.5 (指定目录结构树生成)**: `NpmlRequestGenerator` 依赖 `DirectoryTreeGenerator` 类来生成项目结构树，并将其包含在最终文档中（如果 `options.includeDirTree` 被指定）。
*   **功能 1.7 (CLI工具)**: `NpmlRequestGenerator` 是 CLI 工具执行 `npml [file]` 命令时调用的核心业务逻辑。CLI 负责解析参数并将其转换为 `GenerationOptions` 传递给此功能。