### **功能 1.5 开发文档：指定目录结构树生成**

**功能概述**

本功能负责根据用户提供的一个本地目录路径，递归遍历该目录下的所有文件和子目录，并以一种清晰的树状格式（类似于 `tree` 命令的输出）生成该目录的结构字符串。此功能是 NPML 翻译请求文生成流程的一部分，用于向翻译器提供项目整体的文件组织结构信息。

**接口与实现类**

*   **核心类**: `DirectoryTreeGenerator`
    *   负责协调目录遍历、结构化表示和格式化输出的逻辑。
*   **方法**: `async generateTree(dirPath: string): Promise<string | null>`
    *   **功能**: 接收一个目录路径，递归扫描其内容，并返回一个格式化的目录树字符串。
    *   **返回值**: 一个 `Promise`，其结果为 `string | null`。成功时，返回一个代表目录结构的字符串。失败时（例如，路径不存在、路径不是目录、或访问被拒绝），返回 `null`。

**输入与输出**

*   **输入**: `dirPath: string` - 一个指向本地文件系统的目录路径（可以是绝对路径或相对于当前工作目录的相对路径）。
*   **输出**: `Promise<string | null>`
    *   **成功 (`string`)**: 返回一个格式化的字符串，表示目录树。格式应与 `project.md` 中描述的一致，例如：
        ```
        docs/
         libs/
          fresh/
         project.md
        routes/
         api/
          index.tsx
         islands/
        deno.json
        main.ts
        ```
        *   每个目录名后跟 `/`。
        *   使用空格缩进表示层级关系。
        *   文件名不带 `/`。
    *   **失败 (`null`)**: 如果提供的 `dirPath` 不存在、不是一个目录、或由于权限问题无法访问，则返回 `null`。

**实现细节**

*   **路径验证**:
    *   首先，使用 Deno 标准库（如 `Deno.stat`）检查 `dirPath` 是否存在且为一个目录。如果验证失败，则直接返回 `null`。
*   **递归遍历**:
    *   定义一个内部辅助函数，例如 `traverse(path: string, prefix: string, isLast: boolean): Promise<string>`
        *   `path`: 当前正在遍历的路径。
        *   `prefix`: 用于表示当前层级的缩进和分支符号（如 `├──`, `└──`, `│`）的字符串。
        *   `isLast`: 一个布尔值，表示当前项是否为其父目录中的最后一项，用于决定使用 `├──` 还是 `└──`。
    *   此函数负责读取指定 `path` 下的直接子项（使用 `Deno.readDir`）。
    *   **过滤隐藏目录**: 在读取子项列表后，需要过滤掉名称以 `.` 开头的目录项（例如 `.git`, `.vscode`, `.venv`）。文件不受此规则影响，即使名称以 `.` 开头也会被包含。
    *   对每个子项，判断其是文件还是目录。
    *   根据子项的顺序和是否为最后一个，生成正确的 `prefix` 字符串（例如，如果当前项是最后一个，则下级的前缀应为 `prefix + "   "`；否则为 `prefix + "│  "`）。
    *   如果子项是目录，递归调用自身。
    *   将所有子项的输出拼接起来。
*   **格式化输出**:
    *   主 `generateTree` 函数调用 `traverse` 辅助函数，起始路径为 `dirPath`，起始 `prefix` 为空字符串，`isLast` 为 `true`（因为根目录本身是唯一的）。
    *   `traverse` 函数返回的字符串即为最终的目录树格式化结果。
*   **排序**:
    *   为了保证输出的一致性，建议在遍历每个目录的子项时，先对子项列表（经过隐藏目录过滤后）进行排序（例如，按名称字母顺序排序，目录名在前，文件名在后）。

**功能测试**

*   **有效目录路径**: 测试一个包含多级子目录、文件以及 `.hidden_dir` 的路径，验证输出的树状结构是否正确反映了实际的文件系统结构，并确认 `.hidden_dir` 及其内容未被包含。
*   **空目录**: 测试一个没有任何子文件或子目录的空目录，验证输出是否为该目录名后跟 `/`。
*   **不存在的路径**: 测试一个不存在的路径，验证函数返回 `null`。
*   **指向文件而非目录的路径**: 测试一个指向文件的路径，验证函数返回 `null`。
*   **权限不足**: 在一个没有读取权限的目录上运行，验证函数返回 `null`。
*   **包含特殊字符的路径**: 测试包含空格、中文或其他特殊字符的路径名，确保遍历和输出正确。
*   **输出格式**: 仔细检查输出的缩进、分支符号（`├──`, `└──`, `│`）是否符合 `project.md` 中描述的树状格式。

**与其他功能的关系**

*   **功能 1.6 (NPML翻译请求文生成)**: 功能 1.6 会调用 `DirectoryTreeGenerator.generateTree` 来获取项目结构信息。如果 CLI 参数 `-t` 指定了目录，则此功能的输出将被包含在最终生成的 NPML 翻译请求文的 "项目结构说明" 部分。