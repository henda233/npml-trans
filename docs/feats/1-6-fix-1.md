### 功能 1.6-fix-1 开发文档：NPML翻译请求文「文件输出」补充能力  
文件名：1-6-fix-1.md

---

#### 1. 功能模块概述  
在既有的「功能 1.6」基础上，补齐「将最终生成的 Markdown 文档写入文件系统」的能力。  
写入位置固定为「与输入 .npml 文件同一目录、同名（仅扩展名改为 .md）」，覆盖时无二次确认。  
CLI 默认行为由「仅控制台回显」改为「文件输出」；如用户仍需要剪贴板，则保留 `-c` 开关，且 `-c` 与文件输出互斥（优先级：剪贴板 > 文件）。

---

#### 2. 开发类型  
修改（对功能 1.6 的增强，非新增独立功能）。

---

#### 3. 可能用到的标准库 / 框架 / 第三方库  

| 名称 | 类型 | 用途 | 配置/导入示例 |
|---|---|---|---|
| `std/path` | Deno 标准库 | 安全地拼接、解析文件路径 | `import * as path from "jsr:@std/path";` |
| `std/fs` | Deno 标准库 | 写文件、确保目录存在 | `import * as fs from "jsr:@std/fs";` |
| `std/flags` | Deno 标准库 | 在 CLI 侧解析互斥选项 | 已存在，无需新增 |

> 注：不引入第三方库，仅用 Deno 官方维护的 `std`。

---

#### 4. 功能具体实现细节（伪代码）

```pseudo
函数 fileOutput(mdContent, npmlFilePath):
    1. 解析输入路径
       dir ← dirname(npmlFilePath)
       base ← basename(npmlFilePath, extname(npmlFilePath))
       outFile ← join(dir, base + ".md")

    2. 确保父目录存在
       ensureFileSync(outFile)

    3. 原子写入
       Deno.writeTextFileSync(outFile, mdContent, { create: true, truncate: true })

    4. 返回 outFile（绝对路径字符串）或抛出异常

在 NpmlRequestGenerator.generateRequest 末尾：
    if options.outputToClipboard:
        走剪贴板分支（已存在）
    else:
        try:
            writtenPath ← fileOutput(finalContent, npmlFilePath)
            console.log(`✔ NPML翻译请求文已写入：${writtenPath}`)
            return finalContent        // 保持向后兼容
        catch e:
            console.error(`[Error] 文件输出失败：${e.message}`)
            return null
```

---

#### 5. 可能会创建的类 / 接口 / 函数  

| 名称 | 类型 | 职责 |
|---|---|---|
| `fileOutput()` | 纯函数 | 把 Markdown 内容写盘，返回最终路径 |
| （可选）`FileWriter` 类 | 类 | 若后续还有其它写盘需求，可升格为类，目前保持函数粒度即可 |

接口无需新增；`GenerationOptions` 保留原状。

---

#### 6. 与项目其他功能的关系（依赖关系）

```
功能 1.6-fix-1
 ├─依赖 1.1（FileReader 已保证 npmlFilePath 有效）
 ├─依赖 1.3（行号化内容已就绪）
 ├─依赖 1.6 原流程（聚合逻辑不变）
 ├─被 1.7（CLI）调用：CLI 的默认分支由「console.log」改为「调用 fileOutput」）
 └─不依赖 1.4 / 1.5 的内部细节，仅使用它们产生的字符串结果
```

---

#### 7. 测试要点（供 QA 参考）

1. 正常文件输出：  
   `npml main.npml` → 同目录出现 `main.md`，内容与控制台回显一致。  
2. 覆盖写：再次执行不报错，内容更新。  
3. 只读目录：应返回非 0 退出码并打印友好错误。  
4. 与 `-c` 互斥：同时给出 `-c` 时，剪贴板优先，不产生文件。  
5. 特殊文件名：带空格、中文、特殊符号的 `.npml` 需正常生成对应 `.md`。