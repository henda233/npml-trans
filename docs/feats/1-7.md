### 功能 1.7 开发文档：CLI 工具  
---

#### 一、功能模块概述  
实现一个 **命令行入口（CLI）** 程序，作为整个 NPML 翻译器的唯一用户交互面。  
职责：  
1. 解析命令行参数（位置参数、可选标志）。  
2. 调用 1.6 功能生成 NPML 翻译请求文。  
3. 处理输出策略（文件落盘 / 剪贴板 / 异常退出码）。  
4. 提供 `-v`、`-h` 等内建命令。  

---

#### 二、开发类型  
**纯新增实现**（不涉及旧代码修改）。  

---

#### 三、依赖标准库 / 框架 / 第三方库  

| 名称 | 类型 | 用途 | 安装 / 导入示例 |
|---|---|---|---|
| `std/flags` | Deno 标准库 | 解析 `Deno.args` | `import { parse } from "https://deno.land/std@0.208.0/flags/mod.ts";` |
| `std/fs` | Deno 标准库 | `ensureFileSync`（由 `fileOutput` 使用） | 已在 1-6-api 中导入，CLI 无需重复 |
| `std/path` | Deno 标准库 | 安全计算输出路径 | 已在 1-6-api 中导入，CLI 无需重复 |
| `NpmlRequestGenerator` | 项目内部 | 聚合生成 Markdown | `import { NpmlRequestGenerator, fileOutput, GenerationOptions } from "./npml_request_generator.ts";` |
| `FileReader` | 项目内部 | 被 1.6 依赖 | `import { FileReader } from "./file_reader.ts";` |
| `NPMLReferenceReader` | 项目内部 | 被 1.6 依赖 | `import { NPMLReferenceReader } from "./reference_reader.ts";` |
| `DirectoryTreeGenerator` | 项目内部 | 被 1.6 依赖 | `import { DirectoryTreeGenerator } from "./directory_tree_generator.ts";` |

> 注：CLI 本身不直接依赖 1.1/1.4/1.5，仅通过 1.6 的依赖注入间接使用。

---

#### 四、具体实现细节（伪代码）

```
// cli.ts
import { parse } from "std/flags";
...其他导入...

const VERSION = "0.0.1";

function printHelp() {
  console.log(`
npml <file.npml>     生成翻译请求文（默认输出同名 .md）
  -t <dir>            附加目录树
  -c                  输出到剪贴板（不生成文件）
  -dr                 禁用引用读取
  -v                  版本
  -h                  帮助
`);
}

function printVersion() {
  console.log(`npml/${VERSION}`);
}

async function main() {
  const args = parse(Deno.args, {
    boolean: ["c", "dr", "v", "h"],
    string: ["t"],
    alias: { help: "h", version: "v" },
    stopEarly: true,
  });

  if (args.v) { printVersion(); Deno.exit(0); }
  if (args.h || args._.length === 0) { printHelp(); Deno.exit(0); }

  const [npmlFile] = args._;
  if (typeof npmlFile !== "string") {
    console.error("[Error] 必须指定一个 .npml 文件");
    Deno.exit(1);
  }

  // 实例化 1.6 所需依赖
  const fileReader = new FileReader();
  const referenceReader = new NPMLReferenceReader(fileReader);
  const dirTreeGen = new DirectoryTreeGenerator();
  const generator = new NpmlRequestGenerator(fileReader, referenceReader, dirTreeGen);

  const options: GenerationOptions = {
    includeDirTree: args.t,
    skipReferences: args.dr,
    outputToClipboard: args.c,
  };

  const md = await generator.generateRequest(npmlFile, options);
  if (md === null) {
    // 内部已打印 [Error] 详情
    Deno.exit(1);
  }

  if (args.c) {
    // 未来替换为 Deno.writeText(await clipboard(), md)
    console.log("--- Content to be copied to clipboard ---");
    console.log(md);
  } else {
    try {
      const outPath = fileOutput(md, npmlFile);
      console.log(`[OK] 已生成 ${outPath}`);
    } catch (e) {
      console.error(`[Error] 写盘失败: ${e.message}`);
      Deno.exit(1);
    }
  }
}

if (import.meta.main) {
  await main();
}
```

---

#### 五、可能会创建的类 / 接口 / 函数  

| 名称 | 类型 | 说明 |
|---|---|---|
| `main()` | 函数 | 唯一入口，负责参数解析、依赖组装、流程调度 |
| `printHelp()` | 函数 | 打印 `-h` 使用说明 |
| `printVersion()` | 函数 | 打印 `-v` 版本 |
| `main.ts` | 文件 | 整个 CLI 模块，无额外类/接口，保持极简 |

> 不再新增类或接口；所有业务逻辑已下沉到 1.6。

---

#### 六、与其他功能的关系（依赖图）

```
CLI(1.7)
 └── NpmlRequestGenerator(1.6)
      ├── FileReader(1.1+1.3)
      ├── NPMLReferenceReader(1.4)
      └── DirectoryTreeGenerator(1.5)
```

* CLI **不直接** 依赖 1.1/1.3/1.4/1.5，仅通过 1.6 的构造函数注入。  
* 任何底层失败（文件不存在、权限、格式错误）均由 1.6 返回 `null` 并打印 `[Error]`，CLI 仅负责 `Deno.exit(1)`。  

---

#### 七、测试要点（供 QA 参考）

| 场景 | 预期行为 |
|---|---|
| `npml x.npml` | 生成 `x.md`，控制台输出 `[OK] 已生成 /full/path/x.md` |
| `npml -t docs x.npml` | 同上，但文档内包含“项目结构说明”章节 |
| `npml -c x.npml` | 不生成文件，控制台打印剪贴板占位横幅及内容 |
| `npml -dr x.npml` | 文档中无“引用内容”章节 |
| `npml -v` | 打印 `npml/0.0.1` 并退出 |
| `npml -h` | 打印帮助并退出 |
| 文件不可读 | 控制台 `[Error] ...` 并 `Deno.exit(1)` |
| 输出路径无权限 | 同上 |

---

#### 八、未来扩展点  
1. 剪贴板真实写入：等待 Deno 官方 clipboard API 后，在 1.6 内部替换 `console.log` 即可，CLI 零改动。  
2. 子命令风格：可无缝扩展为 `npml generate | validate | convert` 等多子命令模式，当前 `flags` 解析已预留 `stopEarly`。